<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EMVCo QR Parser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111827;
    }

    header {
      background: #111827;
      color: #f9fafb;
      padding: 1rem 1.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    main {
      max-width: 960px;
      margin: 1.5rem auto 2rem;
      padding: 0 1rem;
    }

    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      margin-bottom: 1rem;
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 0.7rem 0.8rem;
      border-radius: 0.5rem;
      border: 1px solid #d4d4d8;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      resize: vertical;
      box-sizing: border-box;
    }

    textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px #4f46e5;
    }

    .btn-row {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: #4f46e5;
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(79, 70, 229, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    button:hover {
      background: #4338ca;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }

    button.secondary:hover {
      background: #d4d4d8;
    }

    .status {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .status.error {
      color: #b91c1c;
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }

    th,
    td {
      padding: 0.45rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: #f3f4f6;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    tr:nth-child(even) td {
      background: #fafafa;
    }

    .path {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      color: #4b5563;
    }

    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    .tag-badge {
      display: inline-block;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .meaning-muted {
      color: #9ca3af;
      font-style: italic;
    }

    footer {
      text-align: center;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 640px) {
      .card {
        padding: 1rem 1rem;
      }

      th,
      td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>EMVCo QR Parser</h1>
    <p>Paste an EMVCo QR payload, and this tool will decode it into TLV fields.</p>
  </header>

  <main>
    <section class="card">
      <h2>1. Input EMVCo QR Payload</h2>
      <label for="payload">Raw EMV String</label>
      <textarea
        id="payload"
        placeholder="Example: 00020101021226...6304ABCD"
      ></textarea>

      <div class="btn-row">
        <button type="button" onclick="handleParse()">
          <span>▶</span> Parse
        </button>
        <button
          type="button"
          class="secondary"
          onclick="document.getElementById('payload').value = ''"
        >
          Clear
        </button>
        <span id="status" class="status">Waiting for input…</span>
      </div>
    </section>

    <section class="card">
      <h2>2. Parsed Fields</h2>
      <div id="results-container">
        <p class="status">No data yet. Paste a payload and click Parse.</p>
      </div>
    </section>
  </main>

  <footer>
    Static client-side parser – safe to host on GitHub Pages.
  </footer>

  <script>
    // Known EMV tags (top level)
    const TAG_LABELS = {
      "00": "Payload Format Indicator",
      "01": "Point of Initiation Method",
      "26": "Merchant Account Information (Template)",
      "27": "Merchant Account Information (Template)",
      "28": "Merchant Account Information (Template)",
      "29": "Merchant Account Information (Template)",
      "30": "Merchant Account Information (Template)",
      "31": "Merchant Account Information (Template)",
      "32": "Merchant Account Information (Template)",
      "33": "Merchant Account Information (Template)",
      "34": "Merchant Account Information (Template)",
      "35": "Merchant Account Information (Template)",
      "36": "Merchant Account Information (Template)",
      "37": "Merchant Account Information (Template)",
      "38": "Merchant Account Information (Template)",
      "39": "Merchant Account Information (Template)",
      "40": "Merchant Account Information (Template)",
      "41": "Merchant Account Information (Template)",
      "42": "Merchant Account Information (Template)",
      "43": "Merchant Account Information (Template)",
      "44": "Merchant Account Information (Template)",
      "45": "Merchant Account Information (Template)",
      "46": "Merchant Account Information (Template)",
      "47": "Merchant Account Information (Template)",
      "48": "Merchant Account Information (Template)",
      "49": "Merchant Account Information (Template)",
      "50": "Merchant Account Information (Template)",
      "51": "Merchant Account Information (Template)",

      "52": "Merchant Category Code",
      "53": "Transaction Currency",
      "54": "Transaction Amount",
      "55": "Tip or Convenience Indicator",
      "56": "Value of Convenience Fee Fixed",
      "57": "Value of Convenience Fee Percentage",
      "58": "Country Code",
      "59": "Merchant Name",
      "60": "Merchant City",
      "61": "Postal Code",
      "62": "Additional Data Field Template",
      "63": "CRC",

      // Common sub-tags inside templates
      sub_00: "Globally Unique Identifier (GUI)",
      sub_01: "Merchant Account / Bank Code / Identifier",
      sub_02: "Account / Wallet / Phone Number",
      sub_03: "Additional Info",
    };

    function parseEmvTlv(payload) {
      const result = [];
      let i = 0;

      while (i + 4 <= payload.length) {
        const id = payload.substring(i, i + 2);
        const lenStr = payload.substring(i + 2, i + 4);

        if (!/^\d{2}$/.test(lenStr)) {
          // Probably hit garbage, break.
          break;
        }

        const len = parseInt(lenStr, 10);
        const valueStart = i + 4;
        const valueEnd = valueStart + len;

        if (valueEnd > payload.length) {
          // Length exceeds available data — invalid TLV, stop.
          break;
        }

        const value = payload.substring(valueStart, valueEnd);

        result.push({ id, length: len, value });

        i = valueEnd;
      }

      return result;
    }

    function flattenEmvFields(tlvs, parentPath = "") {
      const rows = [];

      for (const tlv of tlvs) {
        const path = parentPath ? parentPath + "-" + tlv.id : tlv.id;
        const baseRow = {
          path,
          id: tlv.id,
          length: tlv.length,
          value: tlv.value,
          meaning: TAG_LABELS[tlv.id] || "",
        };

        // Check if we should parse nested TLV (templates)
        const isTemplate =
          (parseInt(tlv.id, 10) >= 26 && parseInt(tlv.id, 10) <= 51) ||
          tlv.id === "62";

        rows.push(baseRow);

        if (isTemplate) {
          const nested = parseEmvTlv(tlv.value);
          for (const n of nested) {
            const nestedRow = {
              path: path + "-" + n.id,
              id: n.id,
              length: n.length,
              value: n.value,
              meaning:
                TAG_LABELS["sub_" + n.id] ||
                TAG_LABELS[n.id] ||
                "(Sub-field)",
            };
            rows.push(nestedRow);
          }
        }
      }

      return rows;
    }

    function renderTable(rows) {
      if (!rows.length) {
        return '<p class="status">No fields decoded.</p>';
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>Path</th>
              <th>Tag</th>
              <th>Len</th>
              <th>Value</th>
              <th>Meaning</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const row of rows) {
        const meaning =
          row.meaning && row.meaning.length
            ? row.meaning
            : '<span class="meaning-muted">Unknown / custom</span>';

        html += `
          <tr>
            <td class="path">${row.path}</td>
            <td>
              <span class="tag-badge">${row.id}</span>
            </td>
            <td>${row.length}</td>
            <td class="code">${escapeHtml(row.value)}</td>
            <td>${meaning}</td>
          </tr>
        `;
      }

      html += "</tbody></table>";
      return html;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function handleParse() {
      const payloadEl = document.getElementById("payload");
      const statusEl = document.getElementById("status");
      const resultsContainer = document.getElementById("results-container");

      let raw = payloadEl.value || "";
      raw = raw.replace(/\s+/g, ""); // remove spaces / newlines

      if (!raw.length) {
        statusEl.textContent = "Please paste a payload first.";
        statusEl.className = "status error";
        resultsContainer.innerHTML =
          '<p class="status error">No input provided.</p>';
        return;
      }

      const tlvs = parseEmvTlv(raw);
      if (!tlvs.length) {
        statusEl.textContent = "Failed to parse TLV structure.";
        statusEl.className = "status error";
        resultsContainer.innerHTML =
          '<p class="status error">Cannot decode payload. Check that it is a valid EMV QR string.</p>';
        return;
      }

      const rows = flattenEmvFields(tlvs);
      const tableHtml = renderTable(rows);

      resultsContainer.innerHTML = tableHtml;
      statusEl.textContent = `Parsed ${rows.length} field(s).`;
      statusEl.className = "status";
    }
  </script>
</body>
</html>
